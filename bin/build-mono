#!/usr/bin/env bash
# bin/build

# fail fast
set -e

# if any command in a pipe fails, kill the script (useful for indent)
set -o pipefail

#
# Configuration ---
#

# Amazon ID
# AWS_ID=""

# Amazon secret
# AWS_SECRET=""

# how to name package and name of unpacked tarball
# MONO_VERSION="mono-2.11.1"

# where to place the packaged binaries
# S3_BUCKET="heroku-buildpack-mono"

#
# Checks ---
#

if [ "$AWS_ID" == "" ]; then
  echo "need configuration: AWS_ID"
  exit 1
fi

if [ "$AWS_SECRET" == "" ]; then
  echo "need configuration: AWS_SECRET"
  exit 1
fi

if [ "$MONO_VERSION" == "" ]; then
  echo "need configuration: MONO_VERSION"
  exit 1
fi

if [ "$S3_BUCKET" == "" ]; then
  echo "need configuration: S3_BUCKET"
  exit 1
fi


MONO_VERSION=$1

if [ "$MONO_VERSION" == "" ]; then
  echo "need argument: MONO_VERSION"
  exit 1
fi

# Utilities
source ./utils

# Get mono
echo "Getting mono" | arrow
source ./get-mono

#
# Build ---
#

#https://codeload.github.com/mono/mono/zip/017dce9

echo "Building $MONO_VERSION" | arrow

BASE_DIR="$( cd -P "$( dirname "$0" )" && pwd )/.."
PACKAGE_DIR="$BASE_DIR/.packages"
BUILD_DIR="$BASE_DIR/mono-build"
mkdir -p "$PACKAGE_DIR"
mkdir -p "$BUILD_DIR"


pushd "$BUILD_DIR"

# zip filename
MONO_ZIP="mono-$MONO_VERSION.zip"

MONO_SOURCES_URL="https://codeload.github.com/mono/mono/zip"
echo "Downloading zip $MONO_SOURCES_URL/$MONO_VERSION to $MONO_ZIP" | arrow
curl --url "$MONO_SOURCES_URL/$MONO_VERSION" -o "$MONO_ZIP"

echo "Unpacking" | arrow
unzip -q "$MONO_ZIP"

pushd "mono-$MONO_VERSION"
  
echo "Configuring" | arrow
./autogen.sh --prefix="$PACKAGE_DIR/mono" --sysconfdir="$PACKAGE_DIR/mono" \
  --disable-moonlight --disable-nls | indent

#echo "Getting monolite" | arrow
#make get-monolite-latest | indent

echo "Building" | arrow
make EXTERNAL_MCS=mcs | indent

echo "Installing" | arrow
make install | indent

popd
popd

#
# Package ---
#

# package filename
MONO_PACKAGE="mono-$MONO_VERSION.tar.gz"

echo "Packaging" | arrow
( cd "$PACKAGE_DIR" ; tar zcf "$MONO_PACKAGE" mono/ )

echo "Sending to S3" | arrow
$BASE_DIR/support/aws/s3 put "$S3_BUCKET" \
  "$MONO_PACKAGE" "$PACKAGE_DIR/$MONO_PACKAGE" | indent

echo "Mono available at https://s3.amazonaws.com/$S3_BUCKET/$MONO_PACKAGE" | arrow
